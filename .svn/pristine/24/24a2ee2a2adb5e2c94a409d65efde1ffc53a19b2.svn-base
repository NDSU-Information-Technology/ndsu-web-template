'use strict';

const gulp = require('gulp');

const autoprefixer = require('gulp-autoprefixer');
const babel = require('gulp-babel');
const browserSync = require('browser-sync').create();
const concat = require('gulp-concat');
const cleanCSS = require('gulp-clean-css');
const fs = require('fs');
const gutil = require('gulp-util');
const rename = require('gulp-rename');
const runSequence = require('run-sequence');
const sass = require('gulp-sass');
const uglify = require('gulp-uglify');

const config = {
    "components": {
        "get": (componentName) => {
            let componentBaseDir = './src/components/' + componentName;
            if (!fs.existsSync(componentBaseDir)) {
                return undefined;
            }
            return {
                "scripts": componentBaseDir + '/**/*.js',
                "styles": componentBaseDir + '/**/*.scss'
            };
        },
        "scripts": "./src/components/**/*.js",
        "styles": "./src/components/**/*.scss"
    },
    "essentials": { 
        "scripts": [
            "./src/essentials/scripts/global.js",
            "./src/essentials/**/*.js"
        ],
        "styles": "./src/essentials/**/*.scss",
    },
    "html": {
        "watch": [
            './**/*.html'
        ]
    },
    "scripts": {
        "compile": [
            {
                "name": "minimal",
                "destFileName": "minimal",
                "sourceFiles": [
                    './src/essentials/scripts/global.js',
                ],
                "components": ['container', 'navbar', 'sticky-bar']
            },
            {
                "name": "full",
                "destFileName": "script",
                "sourceFiles": [
                    './src/essentials/scripts/global.js',
                    './src/essentials/scripts/**/*.js',
                    './src/components/**/*.js'
                ],
                "components": []
            },
        ],
        "dest": './scripts',
        "watch": [
            './src/components/**/*.js',
            './src/essentials/scripts/**/*.js'
        ],
    },
    "styles": {
        "compile": [
            {
                "name": "minimal",
                "destFileName": "minimal",
                "sourceFiles": ['./src/minimal.scss']
            },
            {
                "name": "full",
                "destFileName": "styles",
                "sourceFiles": ['./src/full.scss']
            }
        ],
        "dest": './styles',
        "watch": [
            './src/components/**/*.scss',
            './src/essentials/**/*.scss'
        ]
    }
};

const flatten = arr => arr.reduce(
  (a, b) => a.concat(Array.isArray(b) ? flatten(b) : b), []
);
const generateStyleTask = (sc) => {
    var taskName = 'style:' + sc.name;
    gulp.task(taskName, () => {
        return gulp.src(sc.sourceFiles)
            .pipe(sass().on('error', sass.logError))
            .pipe(rename(sc.destFileName + '.css'))
            .pipe(autoprefixer())
            .pipe(gulp.dest(config.styles.dest))
            .pipe(browserSync.stream())
            .pipe(rename(sc.destFileName + '.min.css'))
            .pipe(cleanCSS())
            .pipe(gulp.dest(config.styles.dest))
            .pipe(browserSync.stream());
    });
    return taskName;
};
const generateScriptTask = (sc) => {
    var taskName = 'script:' + sc.name;
    gulp.task(taskName, () => {
        var sourceFiles = sc.sourceFiles;
        sourceFiles.push(sc.components.map(componentName => {
            var component = config.components.get(componentName);
            if (!component) {
                console.log("WARNING: Component " + componentName + " is not found.")
                return [];
            };
            return component.scripts;
        }));
        return gulp.src(flatten(sourceFiles))
            .pipe(concat(sc.destFileName + '.js'))
            .pipe(babel({
                presets: ['es2015']
            }))
            .pipe(gulp.dest(config.scripts.dest))
            .pipe(rename(sc.destFileName + '.min.js'))
            .pipe(uglify())
            .on('error', function (err) { gutil.log(gutil.colors.red('[Error]'), err.toString()); })
            .pipe(gulp.dest(config.scripts.dest));
    });
    return taskName;
};

let styleTasks = config.styles.compile.map(generateStyleTask);
let scriptTasks = config.scripts.compile.map(generateScriptTask);

gulp.task('styles', () => {
    runSequence(styleTasks, (error) => {
        if (error) {
            console.log(error);
        }
    });
});

gulp.task('scripts', () => {
    runSequence(scriptTasks, (error) => {
        if (error) {
            console.log(error);
        }
    });
});

gulp.task('watch:html', () => {
    gulp.watch(config.html.watch).on('change', browserSync.reload);
});
gulp.task('watch:scripts', () => {
    gulp.watch(config.scripts.watch).on('change', () => {
        gulp.start('scripts', browserSync.reload);
    });
});
gulp.task('watch:styles', () => {
    gulp.watch(config.styles.watch, ['styles']);
});

gulp.task('watch', ['watch:html','watch:scripts', 'watch:styles']);

gulp.task('serve', ['scripts', 'styles'], () => {

    browserSync.init({
        server: {
            baseDir: './',
            index: "template.html"
        }
    });

    gulp.start('watch');
});