document.addEventListener('DOMContentLoaded', function() {
	// uncomment to debug (clears localstorage every time)
	//localStorage.removeItem('ndsuUberFooter');

	var currentTime = new Date();

	if (localStorage.getItem('ndsuUberFooter') === null ||
		localStorage.getItem('ndsuUberFooterRefresh') === null ||
		new Date(localStorage.getItem('ndsuUberFooterRefresh')) < currentTime ) {

		readUberFooterFile();

		// keep track of when we should check for new footers again
		// otherwise cache for 24 hours
		var tomorrow = new Date(currentTime.getFullYear(), currentTime.getMonth(),
			currentTime.getDate() + 1, currentTime.getHours(),
			currentTime.getMinutes(), currentTime.getMilliseconds());

		localStorage.setItem('ndsuUberFooterRefresh', tomorrow);
	}
	else {
		writeUberFooter();
	}

	function readUberFooterFile() {
		var uberFooterType = "";

		// add type parameter if this is the home page
		if (location.host == 'www.ndsu.edu' && location.pathname == '/') {
			uberFooterType = 'type=home&';
		}

		// IE and Firefox/Chrome/etc don't send the protocol the same way
		var jsonSource = 'https://www.ndsu.edu/templates/uberfooter.php?' + uberFooterType + 'jsn&callback=?';

		// jsonp to overcome multiple ndsu.edu domains
		// Warning: JSONP has no error checking!
        var request = new XMLHttpRequest();
        request.open('GET', jsonSource, true);
        request.onload = function() {
            if (request.status >= 200 && request.status< 400){
                var data = JSON.parse(request.responseText);
                localStorage.setItem('ndsuUberFooter', data.uberfooter);
                writeUberFooter();
            }
        };
	}

	function writeUberFooter() {
		if (localStorage.getItem('ndsuUberFooter') !== null) {
            var uberFooter = document.getElementById('uberfooter');
			uberFooter.innerHTML = '<!-- UPDATE ' + localStorage.getItem('ndsuUberFooterRefresh') +
				' -->' + localStorage.getItem('ndsuUberFooter');
		}
	}
});
